<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>ldoc</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><strong>main.lua</strong></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/bit_ids.html">bit_ids</a></li>
  <li><a href="../modules/entities.html">entities</a></li>
  <li><a href="../modules/operations.html">operations</a></li>
  <li><a href="../modules/Lua51_Operations.html">Lua51_Operations</a></li>
  <li><a href="../modules/Lua53_Operations.html">Lua53_Operations</a></li>
  <li><a href="../modules/states.html">states</a></li>
  <li><a href="../modules/storages.html">storages</a></li>
  <li><a href="../modules/systems.html">systems</a></li>
</ul>

</div>

<div id="content">

    <h2>main.lua</h2>
<pre>
<span class="comment">-- minimal example:
</span><span class="comment">-- 3 components: position, velocity and name
</span><span class="comment">-- 2 systems: translator system and "who's on the right most?"
</span><span class="comment">-- creates 3 entities, with these 2 components, but each one with different data
</span><span class="comment">-- run these systems 300x
</span>
<span class="comment">-- requires
</span><span class="keyword">local</span> states   = <span class="global">require</span> <span class="string">'motor.states'</span>
<span class="keyword">local</span> entities = <span class="global">require</span> <span class="string">'motor.entities'</span>
<span class="keyword">local</span> storages = <span class="global">require</span> <span class="string">'motor.storages'</span>
<span class="keyword">local</span> systems  = <span class="global">require</span> <span class="string">'motor.systems'</span>

<span class="comment">-- create the main_state
</span><span class="keyword">local</span> main_state = states.new_state()

<span class="comment">-- Declarations
</span><span class="comment">-- =============
</span>
<span class="comment">-- Declare components
</span><span class="comment">-- ------------------
</span>
<span class="comment">-- declare position, rotation and name component constructors
</span><span class="keyword">local</span> <span class="keyword">function</span> position_constructor(x, y)
  <span class="keyword">return</span> {
    x = x,
    y = y
  }
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> velocity_constructor(v)
  <span class="keyword">return</span> { v }
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> name_constructor(name)
  <span class="keyword">return</span> { name }
<span class="keyword">end</span>

<span class="comment">-- create storages for each component type, and add them in the main_state
</span><span class="keyword">local</span> positions_state_data_id  = states.add_state_data(main_state, storages.new_storage())
<span class="keyword">local</span> velocities_state_data_id = states.add_state_data(main_state, storages.new_storage())
<span class="keyword">local</span> names_state_data_id      = states.add_state_data(main_state, storages.new_storage())

<span class="comment">-- Declare systems
</span><span class="comment">-- ---------------
</span>
<span class="comment">-- declare translator system
</span><span class="keyword">local</span> translator_sys = systems.new_system(
  <span class="comment">-- here you put state datas that won't be associated with entities,
</span>  <span class="comment">-- if no simple state data will be read or written, so you can use `false` instead of {{} ,{}}
</span>  <span class="keyword">false</span>
  ,{
    <span class="comment">-- here you put state datas that will be associated with entities,
</span>    <span class="comment">-- in this case, read velocities and write positions
</span>    {velocities_state_data_id}, {positions_state_data_id}
  },
  <span class="keyword">function</span>(state_datas, simple_state_dt, components)
    <span class="global">print</span>(<span class="string">'translator system begin'</span>)
    <span class="keyword">for</span> i = <span class="number">1</span>, #components <span class="keyword">do</span>
      <span class="keyword">local</span> vel_i = storages.get_entry_content(state_datas[velocities_state_data_id], components[i][<span class="number">1</span>])
      <span class="keyword">local</span> pos_i = storages.get_entry_content(state_datas[positions_state_data_id] , components[i][<span class="number">2</span>])

      <span class="global">print</span>(<span class="string">"\tupdating position ["</span>.. i .. <span class="string">"]: "</span> .. pos_i.x .. <span class="string">" with velocity "</span> .. vel_i[<span class="number">1</span>])
      pos_i.x = pos_i.x + vel_i[<span class="number">1</span>]
    <span class="keyword">end</span>
    <span class="global">print</span>(<span class="string">'translator system end'</span>)
  <span class="keyword">end</span>
)

<span class="comment">-- declare "who's on the right most" system
</span><span class="keyword">local</span> who_in_right_sys = systems.new_system(
  <span class="keyword">false</span>
  ,{
    {positions_state_data_id, names_state_data_id}, <span class="keyword">false</span> <span class="comment">-- you can use false here too :)
</span>  },
  <span class="keyword">function</span>(state_datas, simple_state_dt, components)
    <span class="global">print</span>(<span class="string">'"who\'s on the right most" system begin'</span>)

    <span class="keyword">local</span> rightmost_pos = -<span class="number">999999999</span>
    <span class="keyword">local</span> rightmost_idx = <span class="number">0</span>

    <span class="keyword">for</span> i = <span class="number">1</span>, #components <span class="keyword">do</span>
      <span class="keyword">local</span> pos_i  = storages.get_entry_content(state_datas[positions_state_data_id], components[i][<span class="number">1</span>])

      <span class="global">print</span>(<span class="string">"\tis pos["</span>.. i .. <span class="string">"]: "</span> .. pos_i.x .. <span class="string">" &gt; "</span> .. rightmost_pos .. <span class="string">" ?"</span>)
      <span class="keyword">if</span> pos_i.x  &gt; rightmost_pos <span class="keyword">then</span>
        rightmost_pos = pos_i.x
        rightmost_idx = i
      <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">local</span> name_rm = storages.get_entry_content(state_datas[names_state_data_id], components[rightmost_idx][<span class="number">2</span>])

    <span class="global">print</span>(<span class="string">"\tThe rightmost for now is: "</span> .. name_rm[<span class="number">1</span>])
    <span class="global">print</span>(<span class="string">'"who\'s on the right most" system end'</span>)
  <span class="keyword">end</span>
)


<span class="comment">-- =================
</span><span class="comment">-- Creating entities
</span>
<span class="keyword">for</span> i=<span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span>
  <span class="keyword">local</span> entities_storage = main_state.state_data[main_state.entities_state_data_bit_id]


  <span class="comment">-- create a new entity entry in entities storage
</span>  <span class="keyword">local</span> new_entity_id = storages.new_entry(
    entities_storage,
    entities.new_entity()
  )

  <span class="comment">-- create a new name entry in names storage
</span>  <span class="keyword">local</span> new_name_id = storages.new_entry(
    main_state.state_data[names_state_data_id],
    name_constructor(<span class="string">"entity #"</span> .. i)
  )

  <span class="comment">-- create a new position entry in positions storage
</span>  <span class="keyword">local</span> new_position_id = storages.new_entry(
    main_state.state_data[positions_state_data_id],
    position_constructor(<span class="global">math</span>.random(-<span class="number">50</span>, <span class="number">50</span>), <span class="number">0</span>)
  )

  <span class="comment">-- create a new velocity entry in velocities storage
</span>  <span class="keyword">local</span> new_velocity_id = storages.new_entry(
    main_state.state_data[velocities_state_data_id],
    velocity_constructor(<span class="global">math</span>.random(<span class="number">0</span>, <span class="number">5</span>))
  )

  <span class="comment">-- associating these components in the new entity
</span>  <span class="comment">-- first, get the entry of the created entity
</span>  <span class="keyword">local</span> entry_of_new_entity = storages.get_entry_content(entities_storage, new_entity_id)

  <span class="comment">-- associate it with new_name_id and names state data id
</span>  entities.associate_component(
    entry_of_new_entity,
    new_name_id,
    names_state_data_id
  )

  <span class="comment">-- same
</span>  entities.associate_component(
    entry_of_new_entity,
    new_position_id,
    positions_state_data_id
  )

  <span class="comment">-- same
</span>  entities.associate_component(
    entry_of_new_entity,
    new_velocity_id,
    velocities_state_data_id
  )
<span class="keyword">end</span>

<span class="comment">-- finally, we create a system step with these 2 systems!
</span>states.new_systems_step(main_state, {translator_sys, who_in_right_sys})

<span class="comment">-- setup systems, unfortunately this is still necessary before the first run
</span><span class="keyword">do</span>
  <span class="comment">-- get main_state's entities storage
</span>  <span class="keyword">local</span> entities_storage = main_state.state_data[main_state.entities_state_data_bit_id]

  <span class="comment">-- for each step, for each system in this step, update components ids to iterate
</span>  <span class="keyword">for</span> step_i = <span class="number">1</span>, #main_state.systems <span class="keyword">do</span>
    <span class="keyword">local</span> step = main_state.systems[step_i]

    <span class="keyword">for</span> system_i = <span class="number">1</span>, #step <span class="keyword">do</span>
      systems.update_components_ids_to_iterate(step[system_i], entities_storage.entries)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- in my computer (i5-4460S @ 2.90GHz × 4), motor can process, in this example,
</span><span class="comment">-- 1 million iterations per system per second in (PUC) Lua 5.3
</span><span class="comment">-- and 10 million iterations per system per second in (LÖVE) LuaJIT,
</span><span class="comment">-- in both it's just using only 1 thread!
</span><span class="global">print</span> <span class="string">'run main state start'</span>

<span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">300</span> <span class="keyword">do</span>
  states.run(main_state)
<span class="keyword">end</span>

<span class="global">print</span> <span class="string">'run main state end'</span></pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2018-12-30 17:03:55 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
